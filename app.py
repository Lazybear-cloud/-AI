from flask import Flask, request, jsonify
from flask_cors import CORS
import openai
import os

app = Flask(__name__)
CORS(app, resources={r"/analyze": {"origins": "*"}})  # ìš´ì˜ ì‹œ "https://sunggonggado.com"ìœ¼ë¡œ ì œí•œ

# OpenAI API í‚¤ ì„¤ì • (í™˜ê²½ ë³€ìˆ˜ì—ì„œ ê°€ì ¸ì˜¤ê¸°)
openai.api_key = os.getenv("OPENAI_API_KEY")

@app.route("/", methods=["GET"])
def home():
    return "Flask ì„œë²„ ì •ìƒ ì‘ë™ ì¤‘! í”„ë¡¬í”„íŠ¸ ì…ë ¥123"

@app.route("/analyze", methods=["POST"])
def analyze():
    try:
        data = request.json
        auction_text = data.get("text", "").strip()

        if not auction_text or len(auction_text) < 10:
            return jsonify({"result": "ê²½ë§¤ ë¬¼ê±´ì˜ ìœ„ì¹˜, ê°ì •ê°€, ê·¼ì €ë‹¹ ì—¬ë¶€ ë“±ì˜ ì •ë³´ë¥¼ í¬í•¨í•˜ì—¬ ì…ë ¥í•´ ì£¼ì„¸ìš”."})

        # OpenAI í”„ë¡¬í”„íŠ¸ ìƒì„±
        prompt = f"""
        # ğŸ“Œ ë¶€ë™ì‚° ê²½ë§¤ ê¶Œë¦¬ë¶„ì„ ë¦¬í¬íŠ¸

        ë‹¤ìŒ **ê²½ë§¤ ë¬¼ê±´**ì˜ **ê¶Œë¦¬ë¶„ì„**ì„ ì§„í–‰í•´ì£¼ì„¸ìš”.  
        ì£¼ì–´ì§„ ì •ë³´ë§Œ ë¶„ì„í•˜ë©°, ì¶”ê°€ì ì¸ ì¶”ì¸¡ì€ í•˜ì§€ ë§ˆì„¸ìš”.

        ## **1ï¸âƒ£ ë¬¼ê±´ ê°œìš”**
        ì£¼ì–´ì§„ ê²½ë§¤ ë¬¼ê±´ ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ **ì†Œì¬ì§€, ê°ì •ê°€, ìµœì €ê°€, ë©´ì ** ë“±ì„ ì •ë¦¬í•´ì£¼ì„¸ìš”.

        ## **2ï¸âƒ£ ë“±ê¸°ë¶€ë“±ë³¸ ë¶„ì„**
        | êµ¬ë¶„ | ë“±ê¸°ê¶Œì | ì±„ê¶Œê¸ˆì•¡ | ì†Œë©¸ ì—¬ë¶€ |
        |------|--------|---------|----------|
        | ë§ì†Œê¸°ì¤€ê¶Œë¦¬ | - | - | - |
        | í›„ìˆœìœ„ ê·¼ì €ë‹¹ | - | - | - |
        | ê°€ì••ë¥˜ | - | - | - |

        âœ… **ê²°ë¡ :**  
        - ë§ì†Œê¸°ì¤€ê¶Œë¦¬ í™•ì¸ í›„ ì†Œë©¸ ì—¬ë¶€ ì •ë¦¬  
        - ë‚™ì°° ì‹œ ê¹¨ë—í•œ ìƒíƒœë¡œ ì¸ìˆ˜ ê°€ëŠ¥í•œì§€ ë¶„ì„  

        ## **3ï¸âƒ£ ì„ì°¨ì¸ ë¶„ì„**
        | ì„ì°¨ì¸ | ì ìœ  | ì „ì…ì¼ | í™•ì •ì¼ | ë³´ì¦ê¸ˆ | ì¸ìˆ˜ ì—¬ë¶€ |
        |--------|------|------|------|------|------|
        | - | - | - | - | - | - |

        âœ… **ê²°ë¡ :**  
        - ëŒ€í•­ë ¥ ìˆëŠ” ì„ì°¨ì¸ì˜ ì¡´ì¬ ì—¬ë¶€  
        - ë‚™ì°° í›„ ì¶”ê°€ ë³´ì¦ê¸ˆ ë¶€ë‹´ ì—¬ë¶€  

        ## **4ï¸âƒ£ ì¶”ê°€ ë¦¬ìŠ¤í¬ ë¶„ì„**
        - ê±´ë¬¼ ë…¸í›„í™”, ì§€í•˜ì¸µ ì—¬ë¶€, ëª…ë„ ë‚œì´ë„ ë“± í™•ì¸  

        ## **5ï¸âƒ£ ì…ì°° ì „ëµ ë° ì˜ˆìƒ ë‚™ì°°ê°€**
        - ê³¼ê±° ë§¤ê° ì‚¬ë¡€ ë¹„êµ í›„ ì˜ˆìƒ ë‚™ì°°ê°€ ë¶„ì„  

        ## **ğŸ” ìµœì¢… ê²°ë¡ **
        - ë‚™ì°° ì¶”ì²œ ì—¬ë¶€ ë° ì£¼ìš” ìœ ì˜ì‚¬í•­ ì •ë¦¬  

        ğŸ“ **ì…ì°° ì „ëµ:** (ì¶”ì²œ ì…ì°°ê°€ ì œê³µ)  
        ğŸ“ **ë¦¬ìŠ¤í¬:** (ì¶”ê°€ í™•ì¸ì´ í•„ìš”í•œ ì‚¬í•­)  

        ## **ğŸ“Œ ê²½ë§¤ ë¬¼ê±´ ì •ë³´**
        {auction_text}
        """

        # OpenAI API í˜¸ì¶œ
        response = openai.ChatCompletion.create(
            model="gpt-4-turbo",
            messages=[
                {"role": "system", "content": "ë‹¹ì‹ ì€ ë¶€ë™ì‚° ê²½ë§¤ ê¶Œë¦¬ë¶„ì„ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì‚¬ìš©ìê°€ ì…ë ¥í•œ ë¶€ë™ì‚° ê²½ë§¤ ë¬¼ê±´ì„ ë¶„ì„í•´ ì£¼ì„¸ìš”."},
                {"role": "user", "content": prompt}
            ],
            temperature=0.2,
            max_tokens=3000
        )

        result = response["choices"][0]["message"]["content"]
        return jsonify({"result": result})

    except Exception as e:
        import traceback
        error_message = traceback.format_exc()
        print("ğŸ”¥ ì„œë²„ ì˜¤ë¥˜ ë°œìƒ:\n", error_message)
        return jsonify({"error": str(e)}), 500

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=10000, debug=True)
